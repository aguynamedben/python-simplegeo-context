#!/usr/bin/env python

import unittest
from decimal import Decimal
import random

from simplegeo.context import ContextClient

MY_OAUTH_KEY = 'my_key'
MY_OAUTH_SECRET = 'my_secret'

API_VERSION = '1.0'
API_HOST = 'api.simplegeo.com'
API_PORT = 80

def random_lat_lon():
    return (random.uniform(-90.0, 90.0), random.uniform(-180.0, 180.0))

class ConsumptionTest(unittest.TestCase):
    def setUp(self):
        self.client = ContextClient(MY_OAUTH_KEY, MY_OAUTH_SECRET, API_VERSION, API_HOST, API_PORT)
        self.known_points = [{'lat': 30.283863,
                              'lon': -97.732519,
                              'expected_response': EXPECTED_RESPONSES['darrell_k_royal_stadium']},
                             {'lat': 37.778434,
                              'lon': -122.389146,
                              'expected_response': EXPECTED_RESPONSES['att_park']},
                             {'lat': 39.744026,
                              'lon': -105.019893,
                              'expected_response': EXPECTED_RESPONSES['invesco_field']}]
        self.known_requests = []
        for known_point in self.known_points:
            self.known_requests.append((known_point, self.client.get_context(known_point['lat'], known_point['lon'])))

        self.random_responses = []
        for i in range(10):
            (lat, lon) = random_lat_lon()
            self.random_responses.append(self.client.get_context(lat, lon))

    def test_weather(self):
        for response in self.random_responses:
            self.assertTrue(response['weather'])
            self.assertTrue('temperature' in response['weather'])
            self.assertEqual(response['weather']['temperature'][-1:], 'F')

    def test_demographics(self):
        for response in self.random_responses:
            self.assertTrue(response['demographics'])
            self.assertTrue('metro_score' in response['demographics'])
            self.assertTrue(0 <= int(response['demographics']['metro_score']) <= 10)

    def test_expected_features_are_received(self):
        # Test that all features expected are received
        for (known_point, response) in self.known_requests:
            for expected_feature in known_point['expected_response']['features']:
                found_expected_feature = False
                for received_feature in response['features']:
                    if expected_feature == received_feature:
                        found_expected_feature = True
                self.assertTrue(found_expected_feature)

    def test_received_features_are_expected(self):
        # Test that all features received are expected
        for (known_point, response) in self.known_requests:
            for received_feature in response['features']:
                found_received_feature = False
                for expected_feature in known_point['expected_response']['features']:
                    if received_feature == expected_feature:
                        found_received_feature = True
                self.assertTrue(found_received_feature)

EXPECTED_RESPONSES = {
    'darrell_k_royal_stadium': {'demographics': {'metro_score': '9'}, 'weather': {'message': 'There was not a nearby weather station.', 'code': 404}, 'features': [{'category': 'Time Zone', 'handle': 'SG_7jM3lCPI7D04dgq6Yglzpn_37.960280_-94.829481', 'subcategory': '', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-104.983027'), Decimal('25.835548'), Decimal('-84.659531'), Decimal('49.388611')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'America/Chicago'}, {'category': 'Subnational', 'handle': 'SG_0X40atqKxLyVduZutLTA5S_31.447218_-99.317129', 'subcategory': 'State', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-106.645646'), Decimal('25.837164'), Decimal('-93.508039'), Decimal('36.500704')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': 'TX', 'type': 'Boundary', 'name': 'Texas'}, {'category': 'National', 'handle': 'SG_3uwSAEdXVBzK1ZER9Nqkdp_45.687160_-112.493107', 'subcategory': '', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-179.142471'), Decimal('18.930138'), Decimal('179.78115'), Decimal('71.41218')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'United States of America'}, {'category': 'Neighborhood', 'handle': 'SG_09DvIpGFBF83IitqjJBDWf_30.284313_-97.733270', 'subcategory': '', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-97.741983'), Decimal('30.274908'), Decimal('-97.721882'), Decimal('30.293307')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'UT'}, {'category': 'US Census', 'handle': 'SG_6USdLOhEJwISEW5pfgl6qP_30.288248_-97.725055', 'subcategory': 'Tract', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-97.735709'), Decimal('30.278506'), Decimal('-97.713564'), Decimal('30.297486')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': '48453000401'}, {'category': 'Legislative District', 'handle': 'SG_2WMamKxH8LWbSagvs7rnXT_30.288060_-97.728167', 'subcategory': 'Municipal', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-97.735709'), Decimal('30.278506'), Decimal('-97.72013'), Decimal('30.297486')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': '0146'}, {'category': 'Administrative', 'handle': 'SG_1CMF3cFYwUnu109LStqa0u_30.334692_-97.781954', 'subcategory': 'County', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-98.172977'), Decimal('30.024499'), Decimal('-97.369248'), Decimal('30.628249')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'Travis'}, {'category': 'Municipal', 'handle': 'SG_41bcEmeot99NfzPUAEmAth_30.306437_-97.754767', 'subcategory': 'City', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-97.938383'), Decimal('30.098659'), Decimal('-97.561489'), Decimal('30.516863')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'Austin'}, {'category': 'Postal Code', 'handle': 'SG_1D0rEwHouPxhMPykjtb5RJ_30.293195_-97.737870', 'subcategory': '', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-97.753314'), Decimal('30.278506'), Decimal('-97.72013'), Decimal('30.313464')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': '78705'}, {'category': 'School District', 'handle': 'SG_4EckCuhVNcdrWNqLOht2oV_30.260705_-97.798455', 'subcategory': 'Unified', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-98.011413'), Decimal('30.097099'), Decimal('-97.620842'), Decimal('30.438391')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'Austin Independent School District'}, {'category': 'Arena', 'attribution': '(c) OpenStreetMap (http://openstreetmap.org/) and contributors CC-BY-SA (http://creativecommons.org/licenses/by-sa/2.0/)', 'subcategory': 'Stadium', 'license': 'http://creativecommons.org/licenses/by-sa/2.0/', 'bounds': [Decimal('-97.733787'), Decimal('30.282636'), Decimal('-97.731332'), Decimal('30.284719')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'handle': 'SG_7QeOhXR4dptALoERMRWlBX_30.283681_-97.732557', 'type': 'Entertainment', 'name': 'Darrell K Royal-Texas Memorial Stadium'}, {'category': 'Education', 'attribution': '(c) OpenStreetMap (http://openstreetmap.org/) and contributors CC-BY-SA (http://creativecommons.org/licenses/by-sa/2.0/)', 'subcategory': 'University', 'license': 'http://creativecommons.org/licenses/by-sa/2.0/', 'bounds': [Decimal('-97.741897'), Decimal('30.274778'), Decimal('-97.721764'), Decimal('30.291944')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'handle': 'SG_5UcxGK9eJy1osUXXnZ40qt_30.284078_-97.732866', 'type': 'Public Place', 'name': 'The University of Texas At Austin'}, {'category': 'Urban Area', 'handle': 'SG_6WQD51qQfl7wkULHpoguiD_30.359587_-97.750655', 'subcategory': '', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-97.916667'), Decimal('30.116667'), Decimal('-97.591667'), Decimal('30.591667')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'Austin'}]},
    'att_park': {'demographics': {'metro_score': '10'}, 'weather': {'message': 'There was not a nearby weather station.', 'code': 404}, 'features': [{'category': 'National', 'handle': 'SG_3uwSAEdXVBzK1ZER9Nqkdp_45.687160_-112.493107', 'subcategory': '', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-179.142471'), Decimal('18.930138'), Decimal('179.78115'), Decimal('71.41218')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'United States of America'}, {'category': 'Subnational', 'handle': 'SG_2MySaPILVQG3MoXrsVehyR_37.215297_-119.663837', 'subcategory': 'State', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-124.482003'), Decimal('32.528832'), Decimal('-114.131211'), Decimal('42.009517')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': 'CA', 'type': 'Boundary', 'name': 'California'}, {'category': 'Time Zone', 'handle': 'SG_3tLT0I5cOUWIpoVOBeScOx_41.316130_-119.116571', 'subcategory': '', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-124.733253'), Decimal('32.534622'), Decimal('-114.039345'), Decimal('49.002892')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'America/Los_Angeles'}, {'category': 'Administrative', 'handle': 'SG_7TAYWdlPlAIzUDT7MVwxmZ_37.759717_-122.693971', 'subcategory': 'County', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-123.173825'), Decimal('37.63983'), Decimal('-122.28178'), Decimal('37.929824')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'San Francisco'}, {'category': 'Municipal', 'handle': 'SG_1mNfKHr5aXH7LWgmZL8Uq7_37.759717_-122.693971', 'subcategory': 'City', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-123.173825'), Decimal('37.63983'), Decimal('-122.28178'), Decimal('37.929824')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'San Francisco'}, {'category': 'School District', 'handle': 'SG_4wyrIh6TQId1MiL2cfYa5d_37.759717_-122.693971', 'subcategory': 'Unified', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-123.173825'), Decimal('37.63983'), Decimal('-122.28178'), Decimal('37.929824')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'San Francisco Unified School District'}, {'category': 'Urban Area', 'handle': 'SG_4n4ze6xOdAFr0gp1WboZrN_37.551206_-122.127401', 'subcategory': '', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-122.516667'), Decimal('37.191667'), Decimal('-121.733333'), Decimal('38.041667')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'San Francisco1'}, {'category': 'US Census', 'handle': 'SG_3JxiYHuWo7N9KDYeDSijzl_37.772749_-122.390793', 'subcategory': 'Tract', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-122.40499'), Decimal('37.764379'), Decimal('-122.379681'), Decimal('37.783529')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': '06075060700'}, {'category': 'Postal Code', 'handle': 'SG_4iNdS13pIvPoUBWBnq0U2f_37.766945_-122.393570', 'subcategory': '', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-122.406493'), Decimal('37.749358'), Decimal('-122.379202'), Decimal('37.789791')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': '94107'}, {'category': 'Neighborhood', 'handle': 'SG_6Bv7Cw61hmZjfZ8McTGGM2_37.785379_-122.390793', 'subcategory': '', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-122.398281'), Decimal('37.777029'), Decimal('-122.384281'), Decimal('37.796503')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'South Beach'}, {'category': 'Arena', 'attribution': '(c) OpenStreetMap (http://openstreetmap.org/) and contributors CC-BY-SA (http://creativecommons.org/licenses/by-sa/2.0/)', 'subcategory': 'Stadium', 'license': 'http://creativecommons.org/licenses/by-sa/2.0/', 'bounds': [Decimal('-122.39115'), Decimal('37.777233'), Decimal('-122.387775'), Decimal('37.779731')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'handle': 'SG_4H2GqJDZrc0ZAjKGR8qM4D_37.778406_-122.389506', 'type': 'Entertainment', 'name': 'AT&T Park'}]},
    'invesco_field': {'demographics': {'metro_score': '9'}, 'weather': {'message': 'There was not a nearby weather station.', 'code': 404}, 'features': [{'category': 'Time Zone', 'handle': 'SG_4nMNM1ah9tMVutXTI8wSCB_41.330677_-107.469772', 'subcategory': '', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-116.050735'), Decimal('30.628255'), Decimal('-100.260872'), Decimal('49.000771')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'America/Denver'}, {'category': 'National', 'handle': 'SG_3uwSAEdXVBzK1ZER9Nqkdp_45.687160_-112.493107', 'subcategory': '', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-179.142471'), Decimal('18.930138'), Decimal('179.78115'), Decimal('71.41218')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'United States of America'}, {'category': 'Subnational', 'handle': 'SG_3V8cOXsDm6WVfNAC3GYJpr_38.998545_-105.547826', 'subcategory': 'State', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-109.066811'), Decimal('36.992424'), Decimal('-102.040878'), Decimal('41.003444')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': 'CO', 'type': 'Boundary', 'name': 'Colorado'}, {'category': 'Postal Code', 'handle': 'SG_1RtJ8mJUCkX90AiKEScBp6_39.767096_-105.019932', 'subcategory': '', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-105.038162'), Decimal('39.743451'), Decimal('-104.997607'), Decimal('39.784227')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': '80211'}, {'category': 'Neighborhood', 'handle': 'SG_5aIM28l5oK5UCmVC2O4huP_39.735617_-105.021119', 'subcategory': '', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-105.025338'), Decimal('39.725233'), Decimal('-105.015621'), Decimal('39.747498')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'Sun Valley'}, {'category': 'US Census', 'handle': 'SG_3O7majtYm480OLz6Tb5loy_39.735809_-105.021085', 'subcategory': 'Tract', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-105.025225'), Decimal('39.725319'), Decimal('-105.015637'), Decimal('39.747599')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': '08031000800'}, {'category': 'Legislative District', 'handle': 'SG_1dcdZehYzJrj8RGTRP0TDS_39.749147_-105.012482', 'subcategory': 'Municipal', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-105.025299'), Decimal('39.740148'), Decimal('-104.995989'), Decimal('39.760591')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'Precinct 519'}, {'category': 'Arena', 'attribution': '(c) OpenStreetMap (http://openstreetmap.org/) and contributors CC-BY-SA (http://creativecommons.org/licenses/by-sa/2.0/)', 'subcategory': 'Stadium', 'license': 'http://creativecommons.org/licenses/by-sa/2.0/', 'bounds': [Decimal('-105.021684'), Decimal('39.742624'), Decimal('-105.018423'), Decimal('39.745146')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'handle': 'SG_2fVsRKtErbeZJcs52XUwIk_39.743886_-105.020051', 'type': 'Entertainment', 'name': 'Invesco Field at Mile High'}, {'category': 'Urban Area', 'handle': 'SG_3qkMPICG5pMFYrBwTKJDec_39.731190_-104.984183', 'subcategory': '', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-105.241667'), Decimal('39.5'), Decimal('-104.708333'), Decimal('40.025')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'Denver'}, {'category': 'Administrative', 'handle': 'SG_0aSGDuSeDtvIzbPrdgVMoN_39.762168_-104.875849', 'subcategory': 'County', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-105.109927'), Decimal('39.614337'), Decimal('-104.600302'), Decimal('39.914247')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'Denver'}, {'category': 'Municipal', 'handle': 'SG_5mkJIHfzh3DmXAVkL5ns7C_39.762168_-104.875849', 'subcategory': 'City', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-105.109927'), Decimal('39.614337'), Decimal('-104.600302'), Decimal('39.914247')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'Denver'}, {'category': 'School District', 'handle': 'SG_522ZsELgQtfLcbMKoMPAay_39.762161_-104.875858', 'subcategory': 'Unified', 'license': 'http://creativecommons.org/publicdomain/mark/1.0/', 'bounds': [Decimal('-105.109927'), Decimal('39.614337'), Decimal('-104.600302'), Decimal('39.914247')], 'href': 'http://api.simplegeo.com/1.0/feature/undefined.json', 'abbr': '', 'type': 'Boundary', 'name': 'Denver County School District 1'}]},
}

if __name__ == '__main__':
        unittest.main()
